<!DOCTYPE html> 
<html> 
	<head> 
	<title>Worklist</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"/> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css" />
	<script src="http://code.jquery.com/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js" type="text/javascript"></script>
	
	<script src="/cordys/html5/cordys.mobile.js" type="text/javascript"></script>
	<script src="http://borismoore.github.com/jsrender/jsrender.js" type="text/javascript"></script>

	<script id="taskTemplate" type="text/x-jsrender">
		<li>
			<div >
				<h3 class="ui-li-heading">
				{{if DisplayName}}
					{{:DisplayName}}
				{{else}}
					{{cn:Id}}
				{{/if}}
				{{if TaskStates}}
				<span>({{:TaskStates.State.Count}})</span>
				{{/if}}
				</h3>
			</div>
		</li>
	</script>

	<script type="text/javascript">
		var userData, userModel, taskModel;
		$.views.converters({
			cn: function(value) {
				return value.substring(3).replace(/,.*/, "");
			},
			date: function (value) {
				return value.substring(0,10);
			},
			time: function (value) {
				return value.substring(11,8);
			}
		});
		$(function() {
			userModel = $.cordys.ajax({
				method: "GetUserDetails",
				namespace: "http://schemas.cordys.com/notification/workflow/1.0",
				dataType: 'json',	// the xml result will be converted into js objects
				success: function(data) {
					userData = data;
					console.log(userData);
				},
				async: false
			});
			taskModel = new $.cordys.model({
				objectName: "Target",
				defaults: {
					namespace: "http://schemas.cordys.com/notification/workflow/1.0",
					dataType: "json",
					organization: userData.User.UserDN.replace(/.*?,(?=o=)/,"")
				},
				create: {},
				read: {
					method: "GetAllTargets",
					parameters: [
						{name: "TaskCountRequired", value: "true"}
					],
					iteratorSize: 50,
					success : function(data) {
						var html = $("#taskTemplate").render(data);
						$('#workList')
							.html(html)
							.listview("refresh");
					}
				}
			});
			taskModel.read();
		});
	</script>

</head> 

<body> 

	<div data-role="page" id="mainPage">
		<div data-role="header" data-theme="b">
			<a href="http://www.cordys.com" data-icon="back">Cordys</a>
			<h1>Worklists</h1>
		</div>

		<div data-role="content" data-theme="b">
			<div data-role="controlgroup" data-type="horizontal">
				<a href="tasklist.htm" data-role="button" data-transition="fade" data-theme="c">Personal Tasks</a>
				<a href="worklist.htm" data-role="button" data-transition="fade" data-theme="c" class="ui-btn-active">Worklists</a>
			</div>

			<ul id="workList" data-role="listview" data-theme="c" data-inset="true">
			</ul>
		</div>
	</div>
<script type="text/javascript">
	$("#mainPage").bind( 'pageshow',function(event, ui) {
		if (taskModel) taskModel.read();
	});
</script>

</body>
</html>
