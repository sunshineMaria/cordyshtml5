<!DOCTYPE html> 
<html> 
	<head> 
	<title>Approve</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"/> 
	<link rel="stylesheet" href="/cordys/html5/jquery/jquery.mobile-1.1.0.min.css" />
	<script src="/cordys/html5/jquery/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src="/cordys/html5/jquery/jquery.mobile-1.1.0.min.js" type="text/javascript"></script>
	
	<script src="/cordys/html5/knockout/knockout-2.1.0.js" type="text/javascript"></script>	
	<script src="/cordys/html5/cordys.html5sdk-0.1.js" type="text/javascript"></script>

</head> 

<body> 

	<div data-role="page" id="approvePage">
		<div data-role="header" data-theme="b">
			<h1>Approve</h1>
		</div>

		<div data-role="content" data-theme="b">
			<ul data-role="listview" data-inset="true" id="detailView" data-bind="foreach: Task">
				<li data-role="heading" data-theme="c" data-mini="true">
					<div>
						<a class="ui-link-inherit">
							<h3 class="ui-li-heading"><span data-bind="text:TaskData.ApplicationData.ApproveTask.header.text">Approve Task</span></h3>
						</a>
					</div>
				</li>
				<li data-role="fieldcontain" data-mini="true" id="identifierView">
					<div data-bind="foreach: $root.fields">
						<div class="ui-grid-a">
							<div class="ui-block-a"><label for="fldName" class="ui-bar ui-bar-d" data-bind="text:Description">Name</label></div>
							<div class="ui-block-b"><label id="fldName" class="ui-bar ui-bar-d" data-bind="text:Value" style="font-weight:normal"></label></div>
						</div>
					</div>
				</li>
				<li data-role="fieldcontain" data-mini="true" id="attachmentsView">
					<div data-bind="foreach: $root.attachments">
						<div >
							<a href="#showAttachmentPage" data-bind="text:$data['@description'],click:$root.selectedAttachment">Attachment</a>
						</div>
					</div>
				</li>
				<li data-role="fieldcontain" data-mini="true">
					<div >
						<label for="fldComment" class="ui-input-text">Comment</label>
						<textarea id="fldComment" rows="4"></textarea>
					</div>
				</li>
				<li data-role="fieldcontain" data-mini="true">
					<div data-role="controlgroup" data-type="horizontal" data-theme="d" data-bind="foreach: TaskData.ApplicationData.ApproveTask.options.option">
						<a data-role="button" data-theme="c" data-bind="click:completeTask"><span data-bind="text:$data['@label']"></span></a>
					</div>
				</li>
			</ul>
		</div>

		<script type="text/javascript">
			var taskDetailModel, bindingsApplied = false,
				taskId = getURLParameter(window.location, "taskId");
			$("#approvePage").bind( 'pageshow',function(event, ui) {
				taskDetailModel = $.cordys.workflow.getTaskDetails(taskId, {
					success:function(tasks) {
					//	var pid = tasks[0].ProcessInstanceId;
						$.cordys.process.getBusinessIdentifiers(tasks[0], {
							success:function(identifiers) {
								taskDetailModel.fields(identifiers);
							}
						})
						$.cordys.process.getAttachments(tasks[0], {
							success:function(attachments) {
								taskDetailModel.attachments(attachments);
							}
						})
					}
				});
				taskDetailModel.fields = ko.observableArray();
				taskDetailModel.attachments = ko.observableArray();
				taskDetailModel.selectedAttachment = ko.observable();
				if (!bindingsApplied) {
					ko.applyBindings(taskDetailModel, document.getElementById("approvePage"));
					bindingsApplied = true;
				}
			});

			var claimDone = false;
			function completeTask(btnData) {
				var taskStatus = taskDetailModel.Task()[0].State;
				if (!claimDone && taskStatus != "ASSIGNED") {
					claimDone = true;
					$.cordys.workflow.claimTask(taskDetailModel.Task()[0], { success: function() {
						completeTask(btnData);
					}
					});
					return;
				}
				$.cordys.workflow.completeTask(taskDetailModel.Task()[0], {
					ApproveTask_ApproveTaskDefaultDeliveryModel_OP: {
						'@xmlns': 'http://schemas.cordys.com/approve',
						response: btnData['@value'],
						comment: document.getElementById("fldComment").value
					}
				}, {dataType:'xml'}).done( function() {
					window.history.back();
				});
			}

		</script>
	</div>
	<div data-role="page" id="showAttachmentPage">
		<img id="imgAttachment" style="width: 100%;" />
		<script type="text/javascript">
			$("#showAttachmentPage").bind( 'pageshow',function(event, ui) {
				var $img = $("#imgAttachment");
				$img.hide();
				$.cordys.ajax({
					method: "GetDocument",
					namespace: "http://schemas.cordys.com/documentstore/default/1.0",
					parameters: {
						DocumentURL: taskDetailModel.selectedAttachment().text
					},
					dataType: "json",
					success: function(doc) {
						if (doc.DocumentContent && doc.DocumentContent["@isLocation"]=="false") {
							$img[0].src = "data:image/bmp;base64,"+doc.DocumentContent.text;
							$img.show();
						} else {
							alert("unable to show attachment");
							$.mobile.changePage("#approvePage");
						}
					}
				});
			});
		</script>
	</div>

</body>
</html>
